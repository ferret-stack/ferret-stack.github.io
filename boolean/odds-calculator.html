---
layout: default
---

<div class="odds-calculator-page">
  <!-- Page Header -->
  <div class="calc-header">
    <h1>Premier League Odds Calculator</h1>
    <p class="calc-description">
      ELO-based model analyzing Premier League matches to identify value bets. 
      Updated weekly with the latest match data and bookmaker odds.
    </p>
    <div class="last-updated">
      Last updated: <span id="updateDate">Loading...</span> | 
      Total matches analyzed: <span id="totalMatches">0</span>
    </div>
  </div>

  <!-- EV Threshold Control -->
  <div class="ev-threshold-control">
    <label>
      Value Bet Threshold: 
      <span class="info-icon" title="Minimum edge required to flag as value bet. Lower = more bets with smaller edge, Higher = fewer bets with stronger edge" onclick="showThresholdInfo()">â“˜</span>
    </label>
    <input type="range" id="evThreshold" min="0" max="20" value="5" step="1" onchange="updateEVThreshold()">
    <span id="evValue">5%</span>
    <a href="/an-odd-disclaimer" class="disclaimer-link">View Full Disclaimer</a>
  </div>

  <!-- Match Selection Section -->
  <div class="match-selection-section">
    <!-- Upcoming Fixtures (moved up) -->
    <div class="fixtures-section compact">
      <h2>Quick Select: Upcoming Fixtures</h2>
      <p class="selection-info">
        <strong>Recommended:</strong> Select from these fixtures for full analysis including bookmaker odds comparison and value bet identification.
      </p>
      <div class="fixtures-list" id="fixturesList">
        <!-- Populated from JSON data -->
      </div>
    </div>

    <!-- Manual Team Selector -->
    <div class="team-selector-card">
      <h2>Manual Selection: Any Match</h2>
      <p class="selection-info">
        Choose any two teams for historical analysis. <em>Note: Bookmaker odds comparison only available for upcoming fixtures above.</em>
      </p>
      <div class="match-selector">
        <div class="team-input">
          <label>Home Team</label>
          <select id="homeTeam" onchange="updateCalculation()">
            <option value="">Select Team...</option>
          </select>
        </div>
        
        <div class="vs-indicator">VS</div>
        
        <div class="team-input">
          <label>Away Team</label>
          <select id="awayTeam" onchange="updateCalculation()">
            <option value="">Select Team...</option>
          </select>
        </div>
      </div>
      
      <button class="calculate-btn" onclick="calculateOdds()">
        Calculate Odds
      </button>
    </div>
  </div>
    
    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
      
      <!-- ELO Information -->
      <div class="elo-display">
        <div class="elo-card home">
          <div class="elo-team" id="homeTeamName">Home Team</div>
          <div class="elo-rating" id="homeElo">-</div>
          <div class="elo-rank" id="homeRank">Rank: -</div>
          <div class="form-indicator" id="homeForm">Form: -</div>
        </div>
        
        <div class="elo-card difference">
          <div class="elo-label">ELO Difference</div>
          <div class="elo-diff" id="eloDiff">-</div>
          <div class="elo-band" id="eloBand">Band -</div>
          <div class="band-games" id="bandGames">Based on - games</div>
        </div>
        
        <div class="elo-card away">
          <div class="elo-team" id="awayTeamName">Away Team</div>
          <div class="elo-rating" id="awayElo">-</div>
          <div class="elo-rank" id="awayRank">Rank: -</div>
          <div class="form-indicator" id="awayForm">Form: -</div>
        </div>
      </div>

      <!-- ELO Chart -->
      <div class="elo-chart-container">
        <h3>ELO Progression</h3>
        <div class="date-range-selector">
          <label>From: <input type="date" id="chartStartDate" onchange="updateEloChart()"></label>
          <label>To: <input type="date" id="chartEndDate" onchange="updateEloChart()"></label>
        </div>
        <canvas id="eloChart"></canvas>
      </div>

      <!-- Match Outcome Probabilities -->
      <div class="outcome-card">
        <h3>Match Outcome Probabilities (ELO Band Analysis)</h3>
        <div class="outcome-grid">
          <div class="outcome-item">
            <div class="outcome-label">Home Win</div>
            <div class="outcome-prob" id="homeWinProb">-</div>
            <div class="outcome-odds" id="homeOdds">-</div>
            <div class="bookmaker-row" id="homeBookmaker" style="display:none;">
              <div class="bookmaker-odds">Bookmaker: <span id="bookHomeOdds">-</span></div>
              <div class="value-indicator" id="homeValue">-</div>
            </div>
          </div>
          
          <div class="outcome-item">
            <div class="outcome-label">Draw</div>
            <div class="outcome-prob" id="drawProb">-</div>
            <div class="outcome-odds" id="drawOdds">-</div>
            <div class="bookmaker-row" id="drawBookmaker" style="display:none;">
              <div class="bookmaker-odds">Bookmaker: <span id="bookDrawOdds">-</span></div>
              <div class="value-indicator" id="drawValue">-</div>
            </div>
          </div>
          
          <div class="outcome-item">
            <div class="outcome-label">Away Win</div>
            <div class="outcome-prob" id="awayWinProb">-</div>
            <div class="outcome-odds" id="awayOdds">-</div>
            <div class="bookmaker-row" id="awayBookmaker" style="display:none;">
              <div class="bookmaker-odds">Bookmaker: <span id="bookAwayOdds">-</span></div>
              <div class="value-indicator" id="awayValue">-</div>
            </div>
          </div>
        </div>
        <div id="noOddsMessage" style="display:none; text-align:center; margin-top:10px; color:#666;">
          Bookmaker odds not available for this fixture
        </div>
      </div>

      <!-- Markets Grid -->
      <div class="markets-grid">
        <!-- Total Goals -->
        <div class="market-card">
          <h3>
            Total Goals Markets
            <button class="toggle-btn" onclick="toggleOddsDisplay()">
              <span id="toggleText">Show Odds</span>
            </button>
          </h3>
          <div class="market-items">
            <div class="market-row">
              <span>Over 0.5</span>
              <span class="odds probability" id="over05">-</span>
              <span class="bookmaker-comparison" id="book05" style="display:none;">-</span>
              <span class="value-indicator-small" id="value05" style="display:none;">-</span>
            </div>
            <div class="market-row">
              <span>Over 1.5</span>
              <span class="odds probability" id="over15">-</span>
              <span class="bookmaker-comparison" id="book15" style="display:none;">-</span>
              <span class="value-indicator-small" id="value15" style="display:none;">-</span>
            </div>
            <div class="market-row">
              <span>Over 2.5</span>
              <span class="odds probability" id="over25">-</span>
              <span class="bookmaker-comparison" id="book25" style="display:none;">-</span>
              <span class="value-indicator-small" id="value25" style="display:none;">-</span>
            </div>
            <div class="market-row">
              <span>Over 3.5</span>
              <span class="odds probability" id="over35">-</span>
              <span class="bookmaker-comparison" id="book35" style="display:none;">-</span>
              <span class="value-indicator-small" id="value35" style="display:none;">-</span>
            </div>
            <div class="market-row">
              <span>Over 4.5</span>
              <span class="odds probability" id="over45">-</span>
              <span class="bookmaker-comparison" id="book45" style="display:none;">-</span>
              <span class="value-indicator-small" id="value45" style="display:none;">-</span>
            </div>
          </div>
        </div>

        <!-- Both Teams to Score -->
        <div class="market-card">
          <h3>Both Teams to Score</h3>
          <div class="market-items">
            <div class="market-row">
              <span>BTTS - Yes</span>
              <span class="odds probability" id="bttsYes">-</span>
              <span class="bookmaker-comparison" id="bookBttsYes" style="display:none;">-</span>
              <span class="value-indicator-small" id="valueBttsYes" style="display:none;">-</span>
            </div>
            <div class="market-row">
              <span>BTTS - No</span>
              <span class="odds probability" id="bttsNo">-</span>
              <span class="bookmaker-comparison" id="bookBttsNo" style="display:none;">-</span>
              <span class="value-indicator-small" id="valueBttsNo" style="display:none;">-</span>
            </div>
          </div>
        </div>

        <!-- Head to Head -->
        <div class="market-card">
          <h3>Head to Head Record</h3>
          <div class="market-items" id="h2hContent">
            <div class="no-data">Select teams to view H2H</div>
          </div>
        </div>
      </div>

      <!-- Booking Points -->
      <div class="booking-card">
        <h3>Expected Booking Points</h3>
        <div class="booking-grid">
          <div class="booking-item">
            <span class="booking-label">ELO Band Average:</span>
            <span class="booking-value" id="bandBooking">-</span>
          </div>
          <div class="booking-item">
            <span class="booking-label">Home Team Average:</span>
            <span class="booking-value" id="homeBooking">-</span>
          </div>
          <div class="booking-item">
            <span class="booking-label">Away Team Average:</span>
            <span class="booking-value" id="awayBooking">-</span>
          </div>
          <div class="booking-item highlight">
            <span class="booking-label">Expected Total:</span>
            <span class="booking-value" id="expectedBooking">-</span>
          </div>
        </div>
      </div>

      <!-- Poisson Distribution -->
      <div class="poisson-table">
        <h3>Poisson Score Distribution (Optional Analysis)</h3>
        <div id="poissonGrid" class="poisson-grid">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Information Section -->
  <div class="info-section">
    <h2>How It Works</h2>
    <div class="info-grid">
      <div class="info-card">
        <h3>ðŸ“Š Data Collection</h3>
        <p>Python script scrapes match data from Premier League website weekly, including goals, cards, and all match statistics.</p>
      </div>
      <div class="info-card">
        <h3>ðŸŽ¯ ELO Ratings</h3>
        <p>Each team's strength is measured using ELO ratings that update after every match based on results and opponent strength.</p>
      </div>
      <div class="info-card">
        <h3>ðŸ“ˆ Probability Calculation</h3>
        <p>Historical data grouped by ELO difference bands shows outcome probabilities for similar rating gaps.</p>
      </div>
      <div class="info-card">
        <h3>ðŸ’° Value Identification</h3>
        <p>Compare model probabilities with bookmaker odds. When our probability exceeds implied odds, we've found +EV value.</p>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global variables
let matchesData = [];
let eloBands = [];
let eloHistory = {};
let currentElo = {};
let upcomingFixtures = [];
let refereeStats = {};
let teamStats = {};
let h2hRecords = {};
let eloChart = null;
let evThreshold = 5;
let showAsOdds = false; // Toggle between percentages and decimal odds

// Load all data on page load
async function loadAllData() {
  try {
    // Load all JSON files
    const responses = await Promise.all([
      fetch('/assets/data/matches_data.json'),
      fetch('/assets/data/elo_bands.json'),
      fetch('/assets/data/elo_history.json'),
      fetch('/assets/data/current_elo.json'),
      fetch('/assets/data/upcoming_fixtures.json'),
      fetch('/assets/data/referee_stats.json'),
      fetch('/assets/data/team_stats.json'),
      fetch('/assets/data/h2h_records.json')
    ]);
    
    // Parse JSON data
    matchesData = await responses[0].json();
    eloBands = await responses[1].json();
    eloHistory = await responses[2].json();
    currentElo = await responses[3].json();
    upcomingFixtures = await responses[4].json();
    refereeStats = await responses[5].json();
    teamStats = await responses[6].json();
    h2hRecords = await responses[7].json();
    
    // Initialize page
    initializePage();
    
  } catch (error) {
    console.error('Error loading data:', error);
    // Fallback with empty data
    initializePage();
  }
}

function showThresholdInfo() {
  alert(`Value Bet Threshold Explained:\n\n` +
        `This slider controls the minimum edge required to flag a bet as +EV (positive expected value).\n\n` +
        `â€¢ 5% edge: More betting opportunities, smaller margins\n` +
        `â€¢ 10% edge: Balanced approach\n` +
        `â€¢ 15%+ edge: Very selective, stronger value only\n\n` +
        `Remember: Even +EV bets can lose. This tool identifies value, not guarantees.\n\n` +
        `For full disclaimer and betting advice, click the link below.`);
}

function toggleOddsDisplay() {
  showAsOdds = !showAsOdds;
  document.getElementById('toggleText').textContent = showAsOdds ? 'Show %' : 'Show Odds';
  
  // Recalculate display if teams are selected
  if (document.getElementById('homeTeam').value && document.getElementById('awayTeam').value) {
    calculateOdds();
  }
}

function initializePage() {
  // Update last updated date and total matches
  const today = new Date();
  document.getElementById('updateDate').textContent = today.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
  document.getElementById('totalMatches').textContent = matchesData.length;
  
  // Set date range for chart (default last 2 years)
  document.getElementById('chartStartDate').value = new Date(today.getFullYear() - 2, today.getMonth(), today.getDate()).toISOString().split('T')[0];
  document.getElementById('chartEndDate').value = today.toISOString().split('T')[0];
  
  // Populate team dropdowns
  populateTeamDropdowns();
  
  // Load upcoming fixtures
  loadUpcomingFixtures();
}

function populateTeamDropdowns() {
  const teams = Object.keys(currentElo).sort();
  
  const homeSelect = document.getElementById('homeTeam');
  const awaySelect = document.getElementById('awayTeam');
  
  // Clear existing options except the first
  homeSelect.innerHTML = '<option value="">Select Team...</option>';
  awaySelect.innerHTML = '<option value="">Select Team...</option>';
  
  teams.forEach(team => {
    homeSelect.innerHTML += `<option value="${team}">${team}</option>`;
    awaySelect.innerHTML += `<option value="${team}">${team}</option>`;
  });
}

function loadUpcomingFixtures() {
  const fixturesList = document.getElementById('fixturesList');
  fixturesList.innerHTML = '';
  
  if (!upcomingFixtures || upcomingFixtures.length === 0) {
    fixturesList.innerHTML = '<div class="no-fixtures">No upcoming fixtures available</div>';
    return;
  }
  
  upcomingFixtures.forEach(fixture => {
    const fixtureDiv = document.createElement('div');
    fixtureDiv.className = 'fixture-item';
    fixtureDiv.onclick = () => {
      document.getElementById('homeTeam').value = fixture.home_team;
      document.getElementById('awayTeam').value = fixture.away_team;
      calculateOdds();
    };
    
    // Check for value bets
    const valueBets = fixture.value_bets?.filter(bet => bet.edge >= evThreshold) || [];
    const hasValue = valueBets.length > 0;
    
    fixtureDiv.innerHTML = `
      <div class="fixture-home">${fixture.home_team}</div>
      <div class="fixture-info">
        <div class="fixture-date">${formatDate(fixture.date)}</div>
        <div class="fixture-time">${fixture.time}</div>
        ${hasValue ? `<div class="value-badge">+EV</div>` : ''}
      </div>
      <div class="fixture-away">${fixture.away_team}</div>
    `;
    
    fixturesList.appendChild(fixtureDiv);
  });
}

function updateEVThreshold() {
  evThreshold = parseInt(document.getElementById('evThreshold').value);
  document.getElementById('evValue').textContent = evThreshold + '%';
  
  // Reload fixtures to update value badges
  loadUpcomingFixtures();
  
  // Recalculate if teams are selected
  if (document.getElementById('homeTeam').value && document.getElementById('awayTeam').value) {
    calculateOdds();
  }
}

function updateCalculation() {
  // Auto-calculate if both teams selected
  const homeTeam = document.getElementById('homeTeam').value;
  const awayTeam = document.getElementById('awayTeam').value;
  
  if (homeTeam && awayTeam && homeTeam !== awayTeam) {
    calculateOdds();
  }
}

function calculateOdds() {
  const homeTeam = document.getElementById('homeTeam').value;
  const awayTeam = document.getElementById('awayTeam').value;
  
  if (!homeTeam || !awayTeam) {
    alert('Please select both teams');
    return;
  }
  
  if (homeTeam === awayTeam) {
    alert('Please select different teams');
    return;
  }
  
  // Get ELO ratings
  const homeEloData = currentElo[homeTeam];
  const awayEloData = currentElo[awayTeam];
  
  if (!homeEloData || !awayEloData) {
    alert('ELO data not available for selected teams');
    return;
  }
  
  const homeElo = homeEloData.elo;
  const awayElo = awayEloData.elo;
  const eloDiff = Math.abs(homeElo - awayElo);
  const eloBand = Math.min(Math.floor(eloDiff / 50) + 1, 10);
  
  // Update ELO display
  document.getElementById('homeTeamName').textContent = homeTeam;
  document.getElementById('awayTeamName').textContent = awayTeam;
  document.getElementById('homeElo').textContent = homeElo;
  document.getElementById('homeRank').textContent = `Rank: #${homeEloData.rank}`;
  document.getElementById('awayElo').textContent = awayElo;
  document.getElementById('awayRank').textContent = `Rank: #${awayEloData.rank}`;
  document.getElementById('eloDiff').textContent = eloDiff;
  
  // Update form indicators
  const homeFormData = teamStats[homeTeam]?.form;
  const awayFormData = teamStats[awayTeam]?.form;
  
  if (homeFormData) {
    document.getElementById('homeForm').textContent = `Form: ${homeFormData.form_rating}/10 (${homeFormData.trend})`;
    document.getElementById('homeForm').className = `form-indicator ${homeFormData.trend}`;
  }
  
  if (awayFormData) {
    document.getElementById('awayForm').textContent = `Form: ${awayFormData.form_rating}/10 (${awayFormData.trend})`;
    document.getElementById('awayForm').className = `form-indicator ${awayFormData.trend}`;
  }
  
  // Get band data
  const bandData = eloBands.find(b => b.band === eloBand) || eloBands[0];
  document.getElementById('eloBand').textContent = `Band ${eloBand}: ${bandData.range}`;
  document.getElementById('bandGames').textContent = `Based on ${bandData.total_games} games`;
  
  // Calculate probabilities based on who is stronger
  let homeWinProb, drawProb, awayWinProb;
  if (homeElo > awayElo) {
    // Home team is stronger
    homeWinProb = bandData.home_win_pct;
    drawProb = bandData.draw_pct;
    awayWinProb = bandData.away_win_pct;
  } else {
    // Away team is stronger (flip probabilities)
    homeWinProb = bandData.away_win_pct;
    drawProb = bandData.draw_pct;
    awayWinProb = bandData.home_win_pct;
  }
  
  // Update probabilities
  document.getElementById('homeWinProb').textContent = `${(homeWinProb * 100).toFixed(1)}%`;
  document.getElementById('drawProb').textContent = `${(drawProb * 100).toFixed(1)}%`;
  document.getElementById('awayWinProb').textContent = `${(awayWinProb * 100).toFixed(1)}%`;
  
  // Calculate decimal odds
  document.getElementById('homeOdds').textContent = homeWinProb > 0 ? (1 / homeWinProb).toFixed(2) : '-';
  document.getElementById('drawOdds').textContent = drawProb > 0 ? (1 / drawProb).toFixed(2) : '-';
  document.getElementById('awayOdds').textContent = awayWinProb > 0 ? (1 / awayWinProb).toFixed(2) : '-';
  
  // Check if this fixture has bookmaker odds
  const fixture = upcomingFixtures.find(f => 
    f.home_team === homeTeam && f.away_team === awayTeam
  );
  
  if (fixture && fixture.bookmaker_odds) {
    // Show bookmaker odds and calculate value
    document.getElementById('homeBookmaker').style.display = 'block';
    document.getElementById('drawBookmaker').style.display = 'block';
    document.getElementById('awayBookmaker').style.display = 'block';
    document.getElementById('noOddsMessage').style.display = 'none';
    
    const bookOdds = fixture.bookmaker_odds;
    
    // Home
    if (bookOdds.home) {
      document.getElementById('bookHomeOdds').textContent = bookOdds.home.toFixed(2);
      const impliedProb = 1 / bookOdds.home;
      const edge = (homeWinProb - impliedProb) * 100;
      updateValueIndicator('homeValue', edge);
    }
    
    // Draw
    if (bookOdds.draw) {
      document.getElementById('bookDrawOdds').textContent = bookOdds.draw.toFixed(2);
      const impliedProb = 1 / bookOdds.draw;
      const edge = (drawProb - impliedProb) * 100;
      updateValueIndicator('drawValue', edge);
    }
    
    // Away
    if (bookOdds.away) {
      document.getElementById('bookAwayOdds').textContent = bookOdds.away.toFixed(2);
      const impliedProb = 1 / bookOdds.away;
      const edge = (awayWinProb - impliedProb) * 100;
      updateValueIndicator('awayValue', edge);
    }
  } else {
    // Hide bookmaker odds
    document.getElementById('homeBookmaker').style.display = 'none';
    document.getElementById('drawBookmaker').style.display = 'none';
    document.getElementById('awayBookmaker').style.display = 'none';
    document.getElementById('noOddsMessage').style.display = 'block';
  }
  
  // Update goal markets
  const displayValue = (prob, marketName) => {
    // Always display probability/odds
    let displayText = showAsOdds
        ? (prob > 0 ? (1 / prob).toFixed(2) : '-')
        : `${(prob * 100).toFixed(1)}%`;
    document.getElementById(marketName).textContent = displayText;

    // Bookmaker comparison only if fixture has odds
    if (fixture && fixture.bookmaker_odds) {
        const bookOdds = fixture.bookmaker_odds;
        let marketKey = marketName.replace('over', 'over_').replace('btts', 'btts_');

        if (bookOdds[marketKey]) {
            const bookmakerOdd = bookOdds[marketKey];
            const bookElementId = `book${marketName.charAt(0).toUpperCase() + marketName.slice(1)}`;
            document.getElementById(bookElementId).textContent = bookmakerOdd.toFixed(2);
            document.getElementById(bookElementId).style.display = 'inline';

            const impliedProb = 1 / bookmakerOdd;
            const edge = (prob - impliedProb) * 100;
            const valueElement = document.getElementById(`value${marketName.charAt(0).toUpperCase() + marketName.slice(1)}`);

            if (edge >= evThreshold) {
                valueElement.textContent = `+${edge.toFixed(1)}%`;
                valueElement.className = 'value-indicator-small positive';
            } else if (edge < -5) {
                valueElement.textContent = `${edge.toFixed(1)}%`;
                valueElement.className = 'value-indicator-small negative';
            } else {
                valueElement.textContent = 'Fair';
                valueElement.className = 'value-indicator-small neutral';
            }
            valueElement.style.display = 'inline';
        }
    }
};
  
  displayValue(bandData.over_05_pct, 'over05');
  displayValue(bandData.over_15_pct, 'over15');
  displayValue(bandData.over_25_pct, 'over25');
  displayValue(bandData.over_35_pct, 'over35');
  displayValue(bandData.over_45_pct, 'over45');
  
  // BTTS
  displayValue(bandData.btts_pct, 'bttsYes');
  displayValue(1 - bandData.btts_pct, 'bttsNo');
  
  // Head to Head
  updateH2H(homeTeam, awayTeam);
  
  // Booking Points
  updateBookingPoints(homeTeam, awayTeam, bandData);
  
  // Generate Poisson grid
  generatePoissonGrid(fixture);
  
  // Update ELO chart
  updateEloChart();
  
  // Show results
  document.getElementById('resultsSection').style.display = 'block';
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function updateValueIndicator(elementId, edge) {
  const element = document.getElementById(elementId);
  
  if (edge >= evThreshold) {
    element.className = 'value-indicator positive';
    element.textContent = `+EV ${edge.toFixed(1)}%`;
  } else if (edge < -5) {
    element.className = 'value-indicator negative';
    element.textContent = `-EV ${Math.abs(edge).toFixed(1)}%`;
  } else {
    element.className = 'value-indicator neutral';
    element.textContent = 'Fair';
  }
}

function updateH2H(team1, team2) {
  const h2hContent = document.getElementById('h2hContent');
  
  // Find H2H record (alphabetical order)
  let key;
  if (team1 < team2) {
    key = `${team1}_${team2}`;
  } else {
    key = `${team2}_${team1}`;
  }
  
  const h2h = h2hRecords[key];
  
  if (h2h) {
    const team1Wins = team1 < team2 ? h2h[`${team1}_wins`] : h2h[`${team2}_wins`];
    const team2Wins = team1 < team2 ? h2h[`${team2}_wins`] : h2h[`${team1}_wins`];
    
    h2hContent.innerHTML = `
      <div class="market-row">
        <span>Total Games</span>
        <span>${h2h.total_games}</span>
      </div>
      <div class="market-row">
        <span>${team1} Wins</span>
        <span>${team1 < team2 ? team1Wins : team2Wins}</span>
      </div>
      <div class="market-row">
        <span>Draws</span>
        <span>${h2h.draws}</span>
      </div>
      <div class="market-row">
        <span>${team2} Wins</span>
        <span>${team1 < team2 ? team2Wins : team1Wins}</span>
      </div>
      <div class="market-row">
        <span>Last Result</span>
        <span style="font-size: 0.9em">${h2h.last_result}</span>
      </div>
    `;
  } else {
    h2hContent.innerHTML = '<div class="no-data">No H2H data available</div>';
  }
}

function updateBookingPoints(homeTeam, awayTeam, bandData) {
  const homeStats = teamStats[homeTeam];
  const awayStats = teamStats[awayTeam];
  
  const bandBooking = bandData.avg_booking_points || 40;
  const homeBooking = homeStats?.last_10_avg_booking_points || 40;
  const awayBooking = awayStats?.last_10_avg_booking_points || 40;
  
  // Weighted average: 50% band, 25% each team
  const expected = (bandBooking * 0.5) + (homeBooking * 0.25) + (awayBooking * 0.25);
  
  document.getElementById('bandBooking').textContent = bandBooking.toFixed(1);
  document.getElementById('homeBooking').textContent = homeBooking.toFixed(1);
  document.getElementById('awayBooking').textContent = awayBooking.toFixed(1);
  document.getElementById('expectedBooking').textContent = expected.toFixed(1);
}

function generatePoissonGrid(fixture) {
  const grid = document.getElementById('poissonGrid');
  grid.innerHTML = '';
  
  let matrix = [];
  
  // Use fixture's Poisson matrix if available, otherwise generate default
  if (fixture && fixture.poisson_matrix && fixture.poisson_matrix.length > 0) {
    matrix = fixture.poisson_matrix;
  } else {
    // Generate a default matrix
    for (let i = 0; i < 6; i++) {
      const row = [];
      for (let j = 0; j < 6; j++) {
        // Simple default calculation
        const homeProb = Math.exp(-1.2) * Math.pow(1.2, i) / factorial(i);
        const awayProb = Math.exp(-1.0) * Math.pow(1.0, j) / factorial(j);
        row.push((homeProb * awayProb * 100).toFixed(1));
      }
      matrix.push(row);
    }
  }
  
  // Create header row
  const headerRow = [''];
  for (let i = 0; i < 6; i++) {
    headerRow.push(i.toString());
  }
  
  // Add header
  headerRow.forEach(cell => {
    const div = document.createElement('div');
    div.className = 'poisson-cell poisson-header';
    div.textContent = cell;
    grid.appendChild(div);
  });
  
  // Add data rows
  for (let i = 0; i < matrix.length; i++) {
    // Row header
    const rowHeader = document.createElement('div');
    rowHeader.className = 'poisson-cell poisson-header';
    rowHeader.textContent = i.toString();
    grid.appendChild(rowHeader);
    
    // Data cells
    for (let j = 0; j < matrix[i].length; j++) {
      const div = document.createElement('div');
      div.className = 'poisson-cell';
      
      // Highlight likely scores
      const prob = parseFloat(matrix[i][j]);
      if (prob > 10) {
        div.className += ' poisson-high';
      }
      
      div.textContent = `${(prob * 100).toFixed(1)}%`;
      grid.appendChild(div);
    }
  }
}

function updateEloChart() {
  const homeTeam = document.getElementById('homeTeam').value;
  const awayTeam = document.getElementById('awayTeam').value;
  
  if (!homeTeam || !awayTeam) return;
  
  const startDate = document.getElementById('chartStartDate').value;
  const endDate = document.getElementById('chartEndDate').value;
  
  // Get ELO history for both teams
  const homeHistory = eloHistory[homeTeam] || [];
  const awayHistory = eloHistory[awayTeam] || [];
  
  // Filter by date range
  const filteredHome = homeHistory.filter(h => h.date >= startDate && h.date <= endDate);
  const filteredAway = awayHistory.filter(h => h.date >= startDate && h.date <= endDate);
  
  // Prepare chart data
  const allDates = [...new Set([
    ...filteredHome.map(h => h.date),
    ...filteredAway.map(h => h.date)
  ])].sort();
  
  const homeData = allDates.map(date => {
    const point = filteredHome.find(h => h.date === date);
    return point ? point.elo : null;
  });
  
  const awayData = allDates.map(date => {
    const point = filteredAway.find(h => h.date === date);
    return point ? point.elo : null;
  });
  
  // Create or update chart
  const ctx = document.getElementById('eloChart').getContext('2d');
  
  if (eloChart) {
    eloChart.destroy();
  }
  
  eloChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: allDates.map(d => formatDate(d)),
      datasets: [{
        label: homeTeam,
        data: homeData,
        borderColor: '#109dff',
        backgroundColor: 'rgba(16, 157, 255, 0.1)',
        tension: 0.1,
        spanGaps: true
      }, {
        label: awayTeam,
        data: awayData,
        borderColor: '#ff69b4',
        backgroundColor: 'rgba(255, 105, 180, 0.1)',
        tension: 0.1,
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'ELO Rating'
          }
        }
      }
    }
  });
}

// Utility functions
function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'short',
    year: '2-digit'
  });
}

function factorial(n) {
  if (n === 0 || n === 1) return 1;
  let result = 1;
  for (let i = 2; i <= n; i++) {
    result *= i;
  }
  return result;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  loadAllData();
});
</script>

<style>
/* Additional styles for new features */
.ev-threshold-control {
  background: white;
  padding: 20px;
  border-radius: 15px;
  margin: 20px auto;
  max-width: 600px;
  display: flex;
  align-items: center;
  gap: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.ev-threshold-control label {
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 5px;
}

.info-icon {
  display: inline-block;
  width: 20px;
  height: 20px;
  background: #109dff;
  color: white;
  border-radius: 50%;
  text-align: center;
  line-height: 20px;
  font-size: 12px;
  cursor: pointer;
  transition: transform 0.2s;
}

.info-icon:hover {
  transform: scale(1.1);
}

.disclaimer-link {
  margin-left: auto;
  color: #109dff;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: color 0.3s;
}

.disclaimer-link:hover {
  color: #ff69b4;
  text-decoration: underline;
}

#evThreshold {
  flex: 1;
  max-width: 200px;
}

#evValue {
  font-weight: bold;
  color: #109dff;
  min-width: 40px;
}

.match-selection-section {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.fixtures-section.compact {
  background: white;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}

.selection-info {
  color: #666;
  margin-bottom: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 10px;
}

.selection-info strong {
  color: #109dff;
}

.selection-info em {
  color: #999;
  font-size: 14px;
}

.toggle-btn {
  float: right;
  background: #109dff;
  color: white;
  border: none;
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
}

.toggle-btn:hover {
  background: #0e7fd4;
  transform: translateY(-1px);
}

.market-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
  gap: 10px;
}

.market-row span:first-child {
  flex: 1;
}

.odds.probability {
  font-weight: bold;
  color: #109dff;
  min-width: 60px;
  text-align: right;
}

.bookmaker-comparison {
  color: #666;
  font-size: 14px;
  min-width: 50px;
  text-align: right;
}

.value-indicator-small {
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
  min-width: 50px;
  text-align: center;
}

.value-indicator-small.positive {
  background: #d4edda;
  color: #155724;
}

.value-indicator-small.negative {
  background: #f8d7da;
  color: #721c24;
}

.value-indicator-small.neutral {
  background: #e2e3e5;
  color: #383d41;
}

.form-indicator {
  font-size: 12px;
  margin-top: 5px;
}

.form-indicator.improving {
  color: #28a745;
}

.form-indicator.declining {
  color: #dc3545;
}

.form-indicator.stable {
  color: #6c757d;
}

.band-games {
  font-size: 12px;
  color: #666;
  margin-top: 5px;
}

.bookmaker-row {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #e0e0e0;
}

.value-indicator.positive {
  background: #d4edda;
  color: #155724;
}

.value-indicator.negative {
  background: #f8d7da;
  color: #721c24;
}

.value-indicator.neutral {
  background: #e2e3e5;
  color: #383d41;
}

.date-range-selector {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  justify-content: center;
}

.date-range-selector label {
  display: flex;
  align-items: center;
  gap: 10px;
}

.date-range-selector input {
  padding: 5px 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
}

.booking-card {
  background: white;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  margin-bottom: 40px;
}

.booking-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.booking-item {
  display: flex;
  justify-content: space-between;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 10px;
}

.booking-item.highlight {
  background: linear-gradient(135deg, #109dff 0%, #1e88e5 100%);
  color: white;
}

.booking-label {
  font-weight: 500;
}

.booking-value {
  font-weight: bold;
}

.value-badge {
  background: #28a745;
  color: white;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: bold;
}

.no-fixtures {
  text-align: center;
  padding: 40px;
  color: #666;
}

.no-data {
  text-align: center;
  padding: 20px;
  color: #999;
}
</style>
