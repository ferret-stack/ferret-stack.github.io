---
layout: default
---

<div class="odds-calculator-page">
  <!-- Page Header -->
  <div class="calc-header">
    <h1>Premier League Odds Calculator</h1>
    <p class="calc-description">
      ELO-based model analyzing Premier League matches to identify value bets. 
      Updated weekly with the latest match data and bookmaker odds.
    </p>
    <div class="last-updated">
      Last updated: <span id="updateDate">Loading...</span> | 
      Total matches analyzed: <span id="totalMatches">0</span>
    </div>
  </div>

  <!-- Main Calculator Interface -->
  <div class="calculator-container">
    <!-- Team Selector -->
    <div class="team-selector-card">
      <h2>Select Match</h2>
      <div class="match-selector">
        <div class="team-input">
          <label>Home Team</label>
          <select id="homeTeam" onchange="updateCalculation()">
            <option value="">Select Team...</option>
          </select>
        </div>

        <div class="vs-indicator">VS</div>

        <div class="team-input">
          <label>Away Team</label>
          <select id="awayTeam" onchange="updateCalculation()">
            <option value="">Select Team...</option>
          </select>
        </div>
      </div>

      <button class="calculate-btn" onclick="calculateOdds()">
        Calculate Odds
      </button>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">

      <!-- ELO Information -->
      <div class="elo-display">
        <div class="elo-card home">
          <div class="elo-team" id="homeTeamName">Home Team</div>
          <div class="elo-rating" id="homeElo">-</div>
          <div class="elo-rank" id="homeRank">Rank: -</div>
          <div class="form-indicator" id="homeForm">Form: -</div>
        </div>

        <div class="elo-card difference">
          <div class="elo-label">ELO Difference</div>
          <div class="elo-diff" id="eloDiff">-</div>
          <div class="elo-band" id="eloBand">Band -</div>
          <div class="band-games" id="bandGames">Based on - games</div>
        </div>

        <div class="elo-card away">
          <div class="elo-team" id="awayTeamName">Away Team</div>
          <div class="elo-rating" id="awayElo">-</div>
          <div class="elo-rank" id="awayRank">Rank: -</div>
          <div class="form-indicator" id="awayForm">Form: -</div>
        </div>
      </div>

      <!-- ELO Chart -->
      <div class="elo-chart-container">
        <h3>ELO Progression</h3>
        <div class="date-range-selector">
          <label>From: <input type="date" id="chartStartDate" onchange="updateEloChart()"></label>
          <label>To: <input type="date" id="chartEndDate" onchange="updateEloChart()"></label>
        </div>
        <canvas id="eloChart"></canvas>
      </div>
      
      <div class="ev-threshold-control">
        <label>
          Value Bet Threshold: 
          <span class="info-icon" title="Minimum edge required to flag as value bet. Lower = more bets with smaller edge, Higher = fewer bets with stronger edge">‚Ñπ</span>
        </label>
        <input type="range" id="evThreshold" min="0" max="20" value="5" step="1" onchange="updateEVThreshold()">
        <span id="evValue">5%</span>
        <a href="https://ferret-stack.github.io/boolean/an-odd-disclaimer/" class="disclaimer-link" title="Important information about betting">
          üìã Disclaimer
        </a>
      </div>

      <!-- Match Outcome Probabilities -->
      <div class="outcome-card">
        <h3>Match Outcome Probabilities (ELO Band Analysis)</h3>
        <div class="outcome-grid">
          <div class="outcome-item">
            <div class="outcome-label">Home Win</div>
            <div class="outcome-prob" id="homeWinProb">-</div>
            <div class="outcome-odds" id="homeOdds">-</div>
            <div class="bookmaker-row" id="homeBookmaker" style="display:none;">
              <div class="bookmaker-odds">Bookmaker: <span id="bookHomeOdds">-</span></div>
              <div class="value-indicator" id="homeValue">-</div>
            </div>
          </div>

          <div class="outcome-item">
            <div class="outcome-label">Draw</div>
            <div class="outcome-prob" id="drawProb">-</div>
            <div class="outcome-odds" id="drawOdds">-</div>
            <div class="bookmaker-row" id="drawBookmaker" style="display:none;">
              <div class="bookmaker-odds">Bookmaker: <span id="bookDrawOdds">-</span></div>
              <div class="value-indicator" id="drawValue">-</div>
            </div>
          </div>

          <div class="outcome-item">
            <div class="outcome-label">Away Win</div>
            <div class="outcome-prob" id="awayWinProb">-</div>
            <div class="outcome-odds" id="awayOdds">-</div>
            <div class="bookmaker-row" id="awayBookmaker" style="display:none;">
              <div class="bookmaker-odds">Bookmaker: <span id="bookAwayOdds">-</span></div>
              <div class="value-indicator" id="awayValue">-</div>
            </div>
          </div>
        </div>
        <div id="noOddsMessage" style="display:none; text-align:center; margin-top:10px; color:#666;">
          Bookmaker odds not available for this fixture
        </div>
      </div>

      <!-- Markets Grid -->
      <div class="markets-grid">
        <!-- Total Goals -->
        <div class="market-card">
          <h3>Total Goals (Historical %)</h3>
          <div class="market-items">
            <div class="market-row">
              <span>Over 0.5</span>
              <span class="odds" id="over05">-</span>
            </div>
            <div class="market-row">
              <span>Over 1.5</span>
              <span class="odds" id="over15">-</span>
            </div>
            <div class="market-row">
              <span>Over 2.5</span>
              <span class="odds" id="over25">-</span>
            </div>
            <div class="market-row">
              <span>Over 3.5</span>
              <span class="odds" id="over35">-</span>
            </div>
            <div class="market-row">
              <span>Over 4.5</span>
              <span class="odds" id="over45">-</span>
            </div>
          </div>
        </div>

      <div class="market-card">
        <h3>BTTS & Booking Points</h3>
        <div class="market-items">
          <div class="market-section">
            <h4>Both Teams to Score</h4>
            <div class="market-row">
              <span>BTTS - Yes</span>
              <span class="odds" id="bttsYes">-</span>
            </div>
            <div class="market-row">
              <span>BTTS - No</span>
              <span class="odds" id="bttsNo">-</span>
            </div>
          </div>
          
          <div class="market-divider"></div>
          
          <div class="market-section">
            <h4>Expected Booking Points</h4>
            <div class="market-row">
              <span>Band Avg</span>
              <span class="odds" id="bandBooking">-</span>
            </div>
            <div class="market-row">
              <span>Home Avg</span>
              <span class="odds" id="homeBooking">-</span>
            </div>
            <div class="market-row">
              <span>Away Avg</span>
              <span class="odds" id="awayBooking">-</span>
            </div>
            <div class="market-row highlight">
              <span><strong>Expected</strong></span>
              <span class="odds" id="expectedBooking">-</span>
            </div>
          </div>
        </div>
      </div>

        <!-- Head to Head -->
        <div class="market-card">
          <h3>Head to Head Record</h3>
          <div class="market-items" id="h2hContent">
            <div class="no-data">Select teams to view H2H</div>
          </div>
        </div>
      </div>

      <!-- Poisson Distribution -->
      <div class="poisson-table">
        <h3>Poisson Score Distribution</h3>
        <div id="poissonGrid" class="poisson-grid">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Upcoming Fixtures -->
  <div class="fixtures-section">
    <h2>Upcoming Fixtures</h2>
    <div class="fixtures-list" id="fixturesList">
      <!-- Populated from JSON data -->
    </div>
  </div>

  <!-- Information Section -->
  <div class="info-section">
    <h2>How It Works</h2>
    <div class="info-grid">
      <div class="info-card">
        <h3>üìä Data Collection</h3>
        <p>Python script scrapes match data from Premier League website weekly, including goals, cards, and all match statistics.</p>
      </div>
      <div class="info-card">
        <h3>üéØ ELO Ratings</h3>
        <p>Each team's strength is measured using ELO ratings that update after every match based on results and opponent strength.</p>
      </div>
      <div class="info-card">
        <h3>üìà Probability Calculation</h3>
        <p>Historical data grouped by ELO difference bands shows outcome probabilities for similar rating gaps.</p>
      </div>
      <div class="info-card">
        <h3>üí∞ Value Identification</h3>
        <p>Compare model probabilities with bookmaker odds. When our probability exceeds implied odds, we've found +EV value.</p>
      </div>
    </div>
  </div>
</div>

<div class="small-print">
  <p><strong>Small print:</strong> Have fun, share this with your friends, and buy me a pint if you like:</p>
  <a href="https://buymeacoffee.com/ferret_stack" class="donation-link">
    <span class="beer-icon">üç∫</span>
    Buy Me a Beer
  </a>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Global variables
let matchesData = [];
let eloBands = [];
let eloHistory = {};
let currentElo = {};
let upcomingFixtures = [];
let refereeStats = {};
let teamStats = {};
let h2hRecords = {};
let eloChart = null;
let evThreshold = 5;

// Load all data on page load
async function loadAllData() {
  try {
    // Load all JSON files
    const responses = await Promise.all([
      fetch('/assets/data/matches_data.json'),
      fetch('/assets/data/elo_bands.json'),
      fetch('/assets/data/elo_history.json'),
      fetch('/assets/data/current_elo.json'),
      fetch('/assets/data/upcoming_fixtures.json'),
      fetch('/assets/data/referee_stats.json'),
      fetch('/assets/data/team_stats.json'),
      fetch('/assets/data/h2h_records.json')
    ]);

    // Parse JSON data
    matchesData = await responses[0].json();
    eloBands = await responses[1].json();
    eloHistory = await responses[2].json();
    currentElo = await responses[3].json();
    upcomingFixtures = await responses[4].json();
    refereeStats = await responses[5].json();
    teamStats = await responses[6].json();
    h2hRecords = await responses[7].json();

    // Initialize page
    initializePage();

  } catch (error) {
    console.error('Error loading data:', error);
    // Fallback with empty data
    initializePage();
  }
}

function initializePage() {
  // Update last updated date and total matches
  const today = new Date();
  document.getElementById('updateDate').textContent = today.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
  document.getElementById('totalMatches').textContent = matchesData.length;

  // Set date range for chart (default last 2 years)
  document.getElementById('chartStartDate').value = new Date(today.getFullYear() - 2, today.getMonth(), today.getDate()).toISOString().split('T')[0];
  document.getElementById('chartEndDate').value = today.toISOString().split('T')[0];

  // Populate team dropdowns
  populateTeamDropdowns();

  // Load upcoming fixtures
  loadUpcomingFixtures();
}

function populateTeamDropdowns() {
  const teams = Object.keys(currentElo).sort();

  const homeSelect = document.getElementById('homeTeam');
  const awaySelect = document.getElementById('awayTeam');

  // Clear existing options except the first
  homeSelect.innerHTML = '<option value="">Select Team...</option>';
  awaySelect.innerHTML = '<option value="">Select Team...</option>';

  teams.forEach(team => {
    homeSelect.innerHTML += `<option value="${team}">${team}</option>`;
    awaySelect.innerHTML += `<option value="${team}">${team}</option>`;
  });
}

function loadUpcomingFixtures() {
  const fixturesList = document.getElementById('fixturesList');
  fixturesList.innerHTML = '';

  if (!upcomingFixtures || upcomingFixtures.length === 0) {
    fixturesList.innerHTML = '<div class="no-fixtures">No upcoming fixtures available</div>';
    return;
  }

  upcomingFixtures.forEach(fixture => {
    const fixtureDiv = document.createElement('div');
    fixtureDiv.className = 'fixture-item';
    fixtureDiv.onclick = () => {
      document.getElementById('homeTeam').value = fixture.home_team;
      document.getElementById('awayTeam').value = fixture.away_team;
      calculateOdds();
    };

    // Check for value bets
    const valueBets = fixture.value_bets?.filter(bet => bet.edge >= evThreshold) || [];
    const hasValue = valueBets.length > 0;

    fixtureDiv.innerHTML = `
      <div class="fixture-home">${fixture.home_team}</div>
      <div class="fixture-info">
        <div class="fixture-date">${formatDate(fixture.date)}</div>
        <div class="fixture-time">${fixture.time}</div>
        ${hasValue ? `<div class="value-badge">+EV</div>` : ''}
      </div>
      <div class="fixture-away">${fixture.away_team}</div>
    `;

    fixturesList.appendChild(fixtureDiv);
  });
}

function updateEVThreshold() {
  evThreshold = parseInt(document.getElementById('evThreshold').value);
  document.getElementById('evValue').textContent = evThreshold + '%';

  // Reload fixtures to update value badges
  loadUpcomingFixtures();

  // Recalculate if teams are selected
  if (document.getElementById('homeTeam').value && document.getElementById('awayTeam').value) {
    calculateOdds();
  }
}

function updateCalculation() {
  // Auto-calculate if both teams selected
  const homeTeam = document.getElementById('homeTeam').value;
  const awayTeam = document.getElementById('awayTeam').value;

  if (homeTeam && awayTeam && homeTeam !== awayTeam) {
    calculateOdds();
  }
}

function calculateOdds() {
  const homeTeam = document.getElementById('homeTeam').value;
  const awayTeam = document.getElementById('awayTeam').value;

  if (!homeTeam || !awayTeam) {
    alert('Please select both teams');
    return;
  }

  if (homeTeam === awayTeam) {
    alert('Please select different teams');
    return;
  }

  // Get ELO ratings
  const homeEloData = currentElo[homeTeam];
  const awayEloData = currentElo[awayTeam];

  if (!homeEloData || !awayEloData) {
    alert('ELO data not available for selected teams');
    return;
  }

  const homeElo = homeEloData.elo;
  const awayElo = awayEloData.elo;
  const eloDiff = Math.abs(homeElo - awayElo);
  const eloBand = Math.min(Math.floor(eloDiff / 50) + 1, 10);

  // Update ELO display
  document.getElementById('homeTeamName').textContent = homeTeam;
  document.getElementById('awayTeamName').textContent = awayTeam;
  document.getElementById('homeElo').textContent = homeElo;
  document.getElementById('homeRank').textContent = `Rank: #${homeEloData.rank}`;
  document.getElementById('awayElo').textContent = awayElo;
  document.getElementById('awayRank').textContent = `Rank: #${awayEloData.rank}`;
  document.getElementById('eloDiff').textContent = eloDiff;

  // Update form indicators
  const homeFormData = teamStats[homeTeam]?.form;
  const awayFormData = teamStats[awayTeam]?.form;

  if (homeFormData) {
    document.getElementById('homeForm').textContent = `Form: ${homeFormData.form_rating}/10 (${homeFormData.trend})`;
    document.getElementById('homeForm').className = `form-indicator ${homeFormData.trend}`;
  }

  if (awayFormData) {
    document.getElementById('awayForm').textContent = `Form: ${awayFormData.form_rating}/10 (${awayFormData.trend})`;
    document.getElementById('awayForm').className = `form-indicator ${awayFormData.trend}`;
  }

  // Get band data
  const bandData = eloBands.find(b => b.band === eloBand) || eloBands[0];
  document.getElementById('eloBand').textContent = `Band ${eloBand}: ${bandData.range}`;
  document.getElementById('bandGames').textContent = `Based on ${bandData.total_games} games`;

  // Calculate probabilities based on who is stronger
  let homeWinProb, drawProb, awayWinProb;
  if (homeElo > awayElo) {
    // Home team is stronger
    homeWinProb = bandData.home_win_pct;
    drawProb = bandData.draw_pct;
    awayWinProb = bandData.away_win_pct;
  } else {
    // Away team is stronger (flip probabilities)
    homeWinProb = bandData.away_win_pct;
    drawProb = bandData.draw_pct;
    awayWinProb = bandData.home_win_pct;
  }

  // Update probabilities
  document.getElementById('homeWinProb').textContent = `${(homeWinProb * 100).toFixed(1)}%`;
  document.getElementById('drawProb').textContent = `${(drawProb * 100).toFixed(1)}%`;
  document.getElementById('awayWinProb').textContent = `${(awayWinProb * 100).toFixed(1)}%`;

  // Calculate decimal odds
  document.getElementById('homeOdds').textContent = homeWinProb > 0 ? (1 / homeWinProb).toFixed(2) : '-';
  document.getElementById('drawOdds').textContent = drawProb > 0 ? (1 / drawProb).toFixed(2) : '-';
  document.getElementById('awayOdds').textContent = awayWinProb > 0 ? (1 / awayWinProb).toFixed(2) : '-';

  // Check if this fixture has bookmaker odds
  const fixture = upcomingFixtures.find(f => 
    f.home_team === homeTeam && f.away_team === awayTeam
  );

  if (fixture && fixture.bookmaker_odds) {
    // Show bookmaker odds and calculate value
    document.getElementById('homeBookmaker').style.display = 'block';
    document.getElementById('drawBookmaker').style.display = 'block';
    document.getElementById('awayBookmaker').style.display = 'block';
    document.getElementById('noOddsMessage').style.display = 'none';

    const bookOdds = fixture.bookmaker_odds;

    // Home
    if (bookOdds.home) {
      document.getElementById('bookHomeOdds').textContent = bookOdds.home.toFixed(2);
      const impliedProb = 1 / bookOdds.home;
      const edge = (homeWinProb - impliedProb) * 100;
      updateValueIndicator('homeValue', edge);
    }

    // Draw
    if (bookOdds.draw) {
      document.getElementById('bookDrawOdds').textContent = bookOdds.draw.toFixed(2);
      const impliedProb = 1 / bookOdds.draw;
      const edge = (drawProb - impliedProb) * 100;
      updateValueIndicator('drawValue', edge);
    }

    // Away
    if (bookOdds.away) {
      document.getElementById('bookAwayOdds').textContent = bookOdds.away.toFixed(2);
      const impliedProb = 1 / bookOdds.away;
      const edge = (awayWinProb - impliedProb) * 100;
      updateValueIndicator('awayValue', edge);
    }
  } else {
    // Hide bookmaker odds
    document.getElementById('homeBookmaker').style.display = 'none';
    document.getElementById('drawBookmaker').style.display = 'none';
    document.getElementById('awayBookmaker').style.display = 'none';
    document.getElementById('noOddsMessage').style.display = 'block';
  }

  // Update goal markets
  document.getElementById('over05').textContent = `${(bandData.over_05_pct * 100).toFixed(1)}%`;
  document.getElementById('over15').textContent = `${(bandData.over_15_pct * 100).toFixed(1)}%`;
  document.getElementById('over25').textContent = `${(bandData.over_25_pct * 100).toFixed(1)}%`;
  document.getElementById('over35').textContent = `${(bandData.over_35_pct * 100).toFixed(1)}%`;
  document.getElementById('over45').textContent = `${(bandData.over_45_pct * 100).toFixed(1)}%`;

  // BTTS
  document.getElementById('bttsYes').textContent = `${(bandData.btts_pct * 100).toFixed(1)}%`;
  document.getElementById('bttsNo').textContent = `${((1 - bandData.btts_pct) * 100).toFixed(1)}%`;

  // Head to Head
  updateH2H(homeTeam, awayTeam);

  // Booking Points
  updateBookingPoints(homeTeam, awayTeam, bandData);

  // Generate Poisson grid
  generatePoissonGrid(homeTeam, awayTeam);

  // Update ELO chart
  updateEloChart();

  // Show results
  document.getElementById('resultsSection').style.display = 'block';
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function updateValueIndicator(elementId, edge) {
  const element = document.getElementById(elementId);

  if (edge >= evThreshold) {
    element.className = 'value-indicator positive';
    element.textContent = `+EV ${edge.toFixed(1)}%`;
  } else if (edge < -5) {
    element.className = 'value-indicator negative';
    element.textContent = `-EV ${Math.abs(edge).toFixed(1)}%`;
  } else {
    element.className = 'value-indicator neutral';
    element.textContent = 'Fair';
  }
}

function updateH2H(team1, team2) {
  const h2hContent = document.getElementById('h2hContent');

  // Find H2H record (alphabetical order)
  let key;
  if (team1 < team2) {
    key = `${team1}_${team2}`;
  } else {
    key = `${team2}_${team1}`;
  }

  const h2h = h2hRecords[key];

  if (h2h) {
    const team1Wins = team1 < team2 ? h2h[`${team1}_wins`] : h2h[`${team2}_wins`];
    const team2Wins = team1 < team2 ? h2h[`${team2}_wins`] : h2h[`${team1}_wins`];

    h2hContent.innerHTML = `
      <div class="market-row">
        <span>Total Games</span>
        <span>${h2h.total_games}</span>
      </div>
      <div class="market-row">
        <span>${team1} Wins</span>
        <span>${team1 < team2 ? team1Wins : team2Wins}</span>
      </div>
      <div class="market-row">
        <span>Draws</span>
        <span>${h2h.draws}</span>
      </div>
      <div class="market-row">
        <span>${team2} Wins</span>
        <span>${team1 < team2 ? team2Wins : team1Wins}</span>
      </div>
      <div class="market-row">
        <span>Last Result</span>
        <span style="font-size: 0.9em">${h2h.last_result}</span>
      </div>
    `;
  } else {
    h2hContent.innerHTML = '<div class="no-data">No H2H data available</div>';
  }
}

function updateBookingPoints(homeTeam, awayTeam, bandData) {
  const homeStats = teamStats[homeTeam];
  const awayStats = teamStats[awayTeam];

  const bandBooking = bandData.avg_booking_points || 40;
  const homeBooking = homeStats?.last_10_avg_booking_points || 40;
  const awayBooking = awayStats?.last_10_avg_booking_points || 40;

  // Weighted average: 50% band, 25% each team
  const expected = (bandBooking * 0.5) + (homeBooking * 0.25) + (awayBooking * 0.25);

  document.getElementById('bandBooking').textContent = bandBooking.toFixed(1);
  document.getElementById('homeBooking').textContent = homeBooking.toFixed(1);
  document.getElementById('awayBooking').textContent = awayBooking.toFixed(1);
  document.getElementById('expectedBooking').textContent = expected.toFixed(1);
}

  // Add this function to calculate Poisson for any match
function calculatePoissonMatrix(homeTeam, awayTeam) {
  // Get team stats
  const homeStats = teamStats[homeTeam];
  const awayStats = teamStats[awayTeam];
  
  if (!homeStats || !awayStats) {
    return null;
  }
  
  // League average (calculate from all matches)
  let totalGoals = 0;
  let totalMatches = matchesData.length;
  matchesData.forEach(match => {
    totalGoals += match.home_goals + match.away_goals;
  });
  const leagueAvg = totalGoals / (totalMatches * 2);
  
  // Calculate expected goals with home advantage
  const homeAttack = homeStats.last_10_avg_goals_for / leagueAvg;
  const homeDefense = homeStats.last_10_avg_goals_against / leagueAvg;
  const awayAttack = awayStats.last_10_avg_goals_for / leagueAvg;
  const awayDefense = awayStats.last_10_avg_goals_against / leagueAvg;
  
  const homeExpected = homeAttack * awayDefense * leagueAvg * 1.1;
  const awayExpected = awayAttack * homeDefense * leagueAvg * 0.9;
  
  // Generate matrix
  const matrix = [];
  for (let i = 0; i < 6; i++) {
    const row = [];
    for (let j = 0; j < 6; j++) {
      const prob = poissonPMF(i, homeExpected) * poissonPMF(j, awayExpected);
      row.push(prob);
    }
    matrix.push(row);
  }
  
  return {
    matrix: matrix,
    homeExpected: homeExpected,
    awayExpected: awayExpected
  };
}

// Poisson probability mass function
function poissonPMF(k, lambda) {
  return Math.exp(-lambda) * Math.pow(lambda, k) / factorial(k);
}

function generatePoissonGrid(homeTeam, awayTeam) {
  const grid = document.getElementById('poissonGrid');
  grid.innerHTML = '';
  
  // Calculate Poisson for this specific match
  const poissonData = calculatePoissonMatrix(homeTeam, awayTeam);
  
  if (!poissonData) {
    grid.innerHTML = '<div class="no-data">Unable to calculate Poisson distribution</div>';
    return;
  }
  
  const matrix = poissonData.matrix;
  
  // Create header row with away team name
  const headerRow = document.createElement('div');
  headerRow.className = 'poisson-cell poisson-corner';
  headerRow.innerHTML = `<small>${awayTeam}<br>Goals ‚Üí</small>`;
  grid.appendChild(headerRow);
  
  for (let i = 0; i < 6; i++) {
    const div = document.createElement('div');
    div.className = 'poisson-cell poisson-header';
    div.textContent = i.toString();
    grid.appendChild(div);
  }
  
  // Add data rows with home team name
  for (let i = 0; i < matrix.length; i++) {
    // Row header with team name on first row
    const rowHeader = document.createElement('div');
    rowHeader.className = 'poisson-cell poisson-header';
    if (i === 0) {
      rowHeader.innerHTML = `<small>${homeTeam}</small><br>${i}`;
    } else {
      rowHeader.textContent = i.toString();
    }
    grid.appendChild(rowHeader);
    
    // Data cells
    for (let j = 0; j < matrix[i].length; j++) {
      const div = document.createElement('div');
      div.className = 'poisson-cell';
      
      const prob = matrix[i][j] * 100;
      
      // Highlight likely scores
      if (prob > 5) {
        div.className += ' poisson-high';
      }
      if (prob > 10) {
        div.className += ' poisson-very-high';
      }
      
      // Add score label on hover
      div.title = `${homeTeam} ${i}-${j} ${awayTeam}: ${prob.toFixed(1)}%`;
      div.textContent = `${prob.toFixed(1)}%`;
      grid.appendChild(div);
    }
  }
  
  // Add expected goals summary
  const existingSummary = document.querySelector('.poisson-summary');
  if (existingSummary) {
    existingSummary.remove();
  }
  
  const summary = document.createElement('div');
  summary.className = 'poisson-summary';
  summary.innerHTML = `
    <strong>Expected Goals:</strong> 
    ${homeTeam}: ${poissonData.homeExpected.toFixed(2)} | 
    ${awayTeam}: ${poissonData.awayExpected.toFixed(2)}
  `;
  grid.parentElement.appendChild(summary);
}

function updateEloChart() {
  const homeTeam = document.getElementById('homeTeam').value;
  const awayTeam = document.getElementById('awayTeam').value;

  if (!homeTeam || !awayTeam) return;

  const startDate = document.getElementById('chartStartDate').value;
  const endDate = document.getElementById('chartEndDate').value;

  // Get ELO history for both teams
  const homeHistory = eloHistory[homeTeam] || [];
  const awayHistory = eloHistory[awayTeam] || [];

  // Filter by date range
  const filteredHome = homeHistory.filter(h => h.date >= startDate && h.date <= endDate);
  const filteredAway = awayHistory.filter(h => h.date >= startDate && h.date <= endDate);

  // Prepare chart data
  const allDates = [...new Set([
    ...filteredHome.map(h => h.date),
    ...filteredAway.map(h => h.date)
  ])].sort();

  const homeData = allDates.map(date => {
    const point = filteredHome.find(h => h.date === date);
    return point ? point.elo : null;
  });

  const awayData = allDates.map(date => {
    const point = filteredAway.find(h => h.date === date);
    return point ? point.elo : null;
  });

  // Create or update chart
  const ctx = document.getElementById('eloChart').getContext('2d');

  if (eloChart) {
    eloChart.destroy();
  }

  eloChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: allDates.map(d => formatDate(d)),
      datasets: [{
        label: homeTeam,
        data: homeData,
        borderColor: '#109dff',
        backgroundColor: 'rgba(16, 157, 255, 0.1)',
        tension: 0.1,
        spanGaps: true
      }, {
        label: awayTeam,
        data: awayData,
        borderColor: '#ff69b4',
        backgroundColor: 'rgba(255, 105, 180, 0.1)',
        tension: 0.1,
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: true
        },
        tooltip: {
          mode: 'index',
          intersect: false
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'ELO Rating'
          }
        }
      }
    }
  });
}

// Utility functions
function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', {
    day: 'numeric',
    month: 'short',
    year: '2-digit'
  });
}

function factorial(n) {
  if (n === 0 || n === 1) return 1;
  let result = 1;
  for (let i = 2; i <= n; i++) {
    result *= i;
  }
  return result;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  loadAllData();
});
</script>
